import{b6 as l,cj as j}from"./common-BQgXWrz2O5Bt.js";import{X as c}from"./router-D2A3v33YTGz9.js";import{f6 as g,f7 as y,f8 as h}from"./render-common-CBDTO_er9s96.js";function R(t,e){const[n,r]=l.useState({receiver:t,id:e.id,version:e.version,value:e});let o=n.value;return(n.receiver!==t||n.id!==e.id)&&(o=t.attached.get(e),r({receiver:t,id:e.id,version:e.version,value:o})),l.useDebugValue(o),l.useEffect(()=>{let s=!1;const a=()=>{s||r(u=>{const{id:d,version:m,receiver:i}=u,{id:f}=e;if(i!==t||d!==f)return u;const x=t.attached.get(e),v=x==null?void 0:x.version;return m===v?u:{receiver:t,value:x,id:f,version:v}})},p=t.attached.subscribe(e,a);return a(),()=>{s=!0,p()}},[t,e]),o}const L=l.memo(function({controller:e,receiver:n}){const{root:r}=n.attached,{children:o}=R(n,r),{renderComponent:s,renderText:a}=e.renderer;return c.jsx(c.Fragment,{children:o.map(p=>{switch(p.kind){case y:return s({parent:r,component:p,receiver:n,controller:e,key:p.id});case g:return a({parent:r,text:p,receiver:n,key:p.id});default:return null}})})}),M={},E=l.memo(function({receiver:e,component:n,controller:r}){const o=r.get(n.type),s=R(e,n),a=l.useMemo(()=>{const u=s==null?void 0:s.props;if(!u)return M;const d={};for(const m of Object.keys(u)){const i=u[m];d[m]=h(i)?c.jsx(I,{parent:n,receiver:e,fragment:i,controller:r}):i}return d},[e,r,s==null?void 0:s.props,n.version]);if(s==null)return null;const{children:p}=s;return p.length===0?c.jsx(o,{...a}):c.jsx(o,{...a,children:C(n,p,e,r)})}),I=l.memo(function({parent:e,receiver:n,fragment:r,controller:o}){var s;const{children:a}=(s=R(n,r))!==null&&s!==void 0?s:{};return a?c.jsx(c.Fragment,{children:C(e,a,n,o)}):null});function C(t,e,n,r){const{renderComponent:o,renderText:s}=r.renderer;return[...e].map(a=>{switch(a.kind){case y:return o({parent:t,component:a,receiver:n,controller:r,key:a.id});case g:return s({parent:t,text:a,receiver:n,key:a.id});default:return null}})}const _=l.memo(function({text:e,receiver:n}){const r=R(n,e);return r?c.jsx(c.Fragment,{children:r.text}):null});function F(t,{renderComponent:e,renderText:n}={}){const r=new Map(Object.entries(t)),o=({parent:u,component:d,controller:m,receiver:i,key:f})=>c.jsx(E,{parent:u,component:d,controller:m,receiver:i},f),s=e?u=>e(u,{renderDefault(){return o(u)}}):o,a=({key:u,receiver:d,text:m,parent:i})=>c.jsx(_,{receiver:d,text:m,parent:i},u);return{get(u){const d=r.get(u);if(d==null)throw new Error(`Unknown component: ${u}`);return d},renderer:{renderComponent:s,renderText:n?u=>n(u,{renderDefault(){return a(u)}}):a}}}function T(){let t,e;return{promise:new Promise((r,o)=>{t=r,e=o}),resolve:t,reject:e}}const k="iframe-worker",w="https://extensions.shopifycdn.com",A=`${w}/shopifycloud/v3/load.html`;function b(){const t=O(),e=new MessageChannel,n=new MessageChannel;return{async load(r,o="unknown"){await(t==null?void 0:t.ready),e.port1.start(),n.port1.start(),t.contentWindow.postMessage({name:o,__run:r,workerPort:e.port2,terminatePort:n.port2},w,[e.port2,n.port2])},postMessage:(...r)=>e.port1.postMessage(...r),addEventListener:(...r)=>e.port1.addEventListener(...r),removeEventListener:(...r)=>e.port1.removeEventListener(...r),terminate(){n.port1.postMessage({action:"terminate"}),e.port1.close(),n.port1.close()}}}function O(){let t=document.querySelector(`#${k}`);if(t==null){const e=T();t=document.createElement("iframe"),t.setAttribute("id",k),t.setAttribute("style","display:none;"),t.setAttribute("hidden","hidden"),t.addEventListener("load",()=>{e.resolve(null)}),t.src=A,t.ready=e.promise,document.body.appendChild(t)}return t}function P(t="unknown"){return e=>{const n=b();return n.load(e.href,t),n}}function $(t,e={}){const n=b();return n.load(t,e.name),j(n,e)}function U(t){const e=t.instance.extension.manifest.handle,n=t.instance.extension.manifest.app.handle;return e?`${n}/${e}`:n}function V(t){return l.useMemo(()=>W(t),[t])}function W(t){return F(t,{renderComponent:({key:e,controller:n,receiver:r,component:o},{renderDefault:s})=>{const{type:a,props:p,children:u}=o,d=t[a].__type__,m=n.get(o.type);return d?c.jsx(m,{__type__:d,...p,children:u.map(i=>{switch(i.kind){case y:return c.jsx(E,{receiver:r,component:i,controller:n,parent:o},i.id);case g:return c.jsx(_,{parent:o,receiver:r,text:i},i.id);default:return null}})},e):s()}})}export{L as R,$ as a,U as b,P as c,F as d,T as e,W as f,V as u};
//# sourceMappingURL=https://web-sourcemaps.shopify.io/v1/en/useController-BAtIEeph53UE.js.map
